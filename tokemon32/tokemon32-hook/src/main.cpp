#include "main.hpp"

/* yes yes I know globals suck but I prefer 
   your lips to theirs honestly, they're puffier
   and so very soft */

HMODULE HOOK_DLL_MODULE;
HHOOK MOUSE_HOOK;
HANDLE PLAYAUDIO_MUTEX;
HANDLE HEYHEY_MUTEX;
HANDLE SMOKEWEED_MUTEX;

__declspec(dllexport) void
LoadHook
(void)
{
   /* I am using global mutexes as switches because I'm dealing 
      with a big stupid global dll injection (thx MS I don't have to
      write my own injection code you made a fucking function <3 <3 <3)

      anyway I'm high, back to the code */

   PLAYAUDIO_MUTEX = CreateMutex(NULL, FALSE, L"Global\\TokemonPlayAudio");
   HEYHEY_MUTEX = CreateMutex(NULL, FALSE, L"Global\\TokemonHeyHey");
   SMOKEWEED_MUTEX = CreateMutex(NULL, FALSE, L"Global\\TokemonSmokeWeed");
   MOUSE_HOOK = SetWindowsHookEx(WH_MOUSE, MouseProc, HOOK_DLL_MODULE, 0);
}

__declspec(dllexport) void
UnloadHook
(void)
{
   ReleaseMutex(PLAYAUDIO_MUTEX);
   ReleaseMutex(HEYHEY_MUTEX);
   ReleaseMutex(SMOKEWEED_MUTEX);
   
   CloseHandle(PLAYAUDIO_MUTEX);
   CloseHandle(HEYHEY_MUTEX);
   CloseHandle(SMOKEWEED_MUTEX);

   UnhookWindowsHookEx(MOUSE_HOOK);
}

LRESULT CALLBACK
MouseProc
(int nCode, WPARAM wParam, LPARAM lParam)
{
   /* thread is spawned to not cockblock your mouse
      believe me you will be mad if your mouse is cockblocked */
   
   switch(wParam)
   {
   case WM_LBUTTONDOWN:
   case WM_RBUTTONDOWN:
      CreateThread(NULL
                   ,8192
                   ,TheGoodDoctor
                   ,(LPVOID)0x420DAB69
                   ,0
                   ,NULL);
      break;
   }

   return CallNextHookEx(NULL, nCode, wParam, lParam);
}

DWORD WINAPI
TheGoodDoctor
(LPVOID DRE)
{
   if (WaitForSingleObject(PLAYAUDIO_MUTEX, 0) == WAIT_OBJECT_0)
   {
      static volatile WCHAR DrDreTheNextEpisode[] = L"La-da-da-da-dahh\n\
It's the motherfuckin D-O-double-G (Snoop Dogg)\n\
La-da-da-da-dahh\n\
You know I'm mobbin with the D.R.E.\n\
(YEAH YEAH YEAH\n\
You know who's back up in this Motherfucker!)\n\
What what what what?\n\
(So blaze the weed up then!)\n\
Blaze it up, blaze it up!\n\
(Just blaze that shit up nigga, yeah, 'sup Snoop??)\n\
\n\
Top Dogg, bite em all, nigga burn the shit up\n\
D-P-G-see my nigga turn that shit up\n\
See-P-T, L-be -see, yeah we hookin back up\n\
And when they bang this in the club baby you got to get up\n\
Thug niggaz drug dealers yeah they givin it up\n\
Lowlife, yo' life, boy we livin it up\n\
Takin chances while we dancin in the party fo' sho'\n\
Slip my hoe a forty-fo' and she got in the back do'\n\
Bitches lookin at me strange but you know I don't care\n\
Step up in this motherfucker just a-swangin my hair\n\
Bitch quit talkin, quick walk if you down with the set\n\
Take a bullet with some dick and take this dope from this jet\n\
Out of town, put it down for the Father of Rap\n\
And if yo' ass get cracked, bitch shut yo' trap\n\
Come back, get back, that's the part of success\n\
If you believe in the S you'll be relievin your stress\n\
\n\
La-da-da-da-dahh\n\
[Dre] It's the motherfuckin D.R.E. (Dr. Dre Motherfucker!)\n\
[Snoop] La-da-da-da-dahhh\n\
[Dre] You know I'm mobbin with the D-O-double-G\n\
\n\
Straight off the fuckin streets of C-P-T\n\
King of the beats you ride to em in your Fleet (Fleetwood)\n\
Or Coupe DeVille rollin on dubs\n\
How you feelin whoopty-whoop nigga whut?\n\
Dre and Snoop chronic'ed out in the 'llac\n\
With Doc in the back, sippin on 'gnac (yeah)\n\
Clip in the strap, dippin through hoods (what hoods?)\n\
Compton, Long Beach, Inglewood!\n\
South Central out to the Westside (wessyde)\n\
It's California Love, this California bud got a nigga gang of pub\n\
I'm on one, I might bail up in the Century Club\n\
With my jeans on, and my team strong\n\
Get my drink on, and my smoke on\n\
Then go home with, somethin to poke on (whassup bitch?)\n\
Loc it's on for the two-triple-oh\n\
Comin real, it's the next episode\n\
\n\
Hold up, wait\n\
For my niggaz who be thinkin we soft\n\
We don't, play\n\
We gon' rock it til the wheels fall off\n\
Hold up, heyyyyyyyy\n\
For my niggaz who be actin too bold\n\
Take a, seat\n\
Hope you ready for the next episode\n\
(click to continue)";

      if (WaitForSingleObject(HEYHEY_MUTEX, 0) == WAIT_OBJECT_0)
      {
         /* intentionally do not release the mutex so it
            plays the next file instead globally */
         
         PlaySound(MAKEINTRESOURCE(IDR_HEYHEY), HOOK_DLL_MODULE, SND_RESOURCE);
      }
      else if (WaitForSingleObject(SMOKEWEED_MUTEX, 0) == WAIT_OBJECT_0)
      {
         DWORD timeout;
         
         PlaySound(MAKEINTRESOURCE(IDR_SMOKEWEED), HOOK_DLL_MODULE, SND_RESOURCE);

         /* this locks up all mutexes, thus, disabling audio for a
            certain period of time.

            hee hee hee. where'd the magic weed man go? who knows!

            sleeps for at minimum five minutes and at maximum 4 hours */
         
         timeout = rand() % (60 * 60 * 4);
         
         Sleep((timeout + 60 * 5) * 1000);

         ReleaseMutex(HEYHEY_MUTEX);
         ReleaseMutex(SMOKEWEED_MUTEX);
      }

      ReleaseMutex(PLAYAUDIO_MUTEX);
   }

   return 0;
}

BOOL WINAPI
DllMain
(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)
{
   switch(fdwReason)
   {
   case DLL_PROCESS_ATTACH:
      HOOK_DLL_MODULE = (HMODULE)hinstDLL;
   }

   srand(time(NULL));

   return TRUE;
}
